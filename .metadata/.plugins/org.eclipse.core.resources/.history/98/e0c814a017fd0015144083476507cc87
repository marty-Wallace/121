package image;

import java.awt.Color;
import java.awt.Graphics2D;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.Collections;
import java.util.List;

import javax.swing.JOptionPane;

import fileManagement.FileManager;
import gui.MosaicGUI;

public class Mosaic {
	
	private static final String TILE_PATH = "res/jpg";
	private static final float RED_WEIGHT = 1.0f;
	private static final float GREEN_WEIGHT = 1.0f;
	private static final float BLUE_WEIGHT = 1.0f;
	
	private BufferedImage image;
	private BufferedImage newImage;
	private Tile[][] mosaic;

	
	
	public BufferedImage createMosaic(BufferedImage image, MosaicGUI gui) {
		this.image = image;

		List<Tile> tiles;
		try {
			 tiles = FileManager.getImagesFromTiles(new File(TILE_PATH));
		} catch (IOException e) {
			JOptionPane.showMessageDialog(gui.getFrame(), "Could not load tiles from the path " + TILE_PATH, "ERROR!" , JOptionPane.ERROR_MESSAGE);
			return null;
		}
		this.mosaic = new Tile[image.getWidth()/tiles.get(0).image.getWidth()][image.getHeight()/tiles.get(0).image.getHeight()];
		
		
		return createImage(tiles);
	}
	
	private BufferedImage createImage(List<Tile> tiles) {
		
		int tileHeight = tiles.get(0).image.getHeight();
		int tileWidth = tiles.get(0).image.getWidth();
		
		for(int i = 0; i < image.getHeight(); i+= tileHeight) {
			for(int j = 0; j < image.getWidth(); j += tileWidth) {
				Tile imagePiece = new Tile(image.getSubimage(j, i, tileWidth, tileHeight));
				mosaic[j][i] = matchImagePiece(imagePiece, tiles);
			}
		}
		
		int width = mosaic[0].length * mosaic[0][0].image.getWidth();
		int height = mosaic.length * mosaic[0][0].image.getHeight();
		newImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
		Graphics2D g = newImage.createGraphics();
        Color oldColor = g.getColor();
        g.setPaint(Color.WHITE);
        g.fillRect(0, 0, width, height);
        //draw image
        g.setColor(oldColor);

		for(int i = 0; i < mosaic.length; i++){
			for(int j = 0; j < mosaic[0].length; j++) {
				g.drawImage(mosaic[j][i].image,null, j * mosaic[j][i].image.getWidth(), i * mosaic[j][i].image.getHeight());
			}
		}
        g.dispose();
        
        return newImage;
	}
	
	private Tile matchImagePiece(Tile imagePiece, List<Tile> tiles) {
		
		int targetBlue = imagePiece.averageBlue;
		int targetRed = imagePiece.averageRed;
		int targetGreen = imagePiece.averageGreen;
		
		for(Tile t : tiles) {
			scoreTileByAverage(t, targetBlue, targetRed, targetGreen);
		}
		Collections.sort(tiles);

		Tile ret = tiles.get(0);
		for(Tile t : tiles) {
			t.score = 0;
		}
		return ret;
	}
	
	private  void addToImage() {
		BufferedImage newImage = new BufferedImage(width,height, BufferedImage.TYPE_INT_ARGB);
        Graphics2D g2 = newImage.createGraphics();
        //do some calculate first
        int offset  = 5;
        int wid = img1.getWidth()+img2.getWidth()+offset;
        int height = Math.max(img1.getHeight(),img2.getHeight())+offset;
        //create a new buffer and draw two image into the new image
        BufferedImage newImage = new BufferedImage(wid,height, BufferedImage.TYPE_INT_ARGB);
        Graphics2D g2 = newImage.createGraphics();
        Color oldColor = g2.getColor();
        //fill background
        g2.setPaint(Color.WHITE);
        g2.fillRect(0, 0, wid, height);
        //draw image
        g2.setColor(oldColor);
        g2.drawImage(img1, null, 0, 0);
        g2.drawImage(img2, null, img1.getWidth()+offset, 0);
        g2.dispose();
        return newImage;
	}
	
	private  void scoreTileByAverage(Tile tile, int targetBlue, int targetRed, int targetGreen) {
		
		int score = 0;
		score += (int) (Math.abs(tile.averageBlue - targetBlue) * BLUE_WEIGHT);
		score += (int)(Math.abs(tile.averageRed - targetRed) * RED_WEIGHT);
		score += (int)(Math.abs(tile.averageGreen - targetGreen) * GREEN_WEIGHT);
		
		
		tile.score = score;
	}

}
